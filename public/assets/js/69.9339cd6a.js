(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{794:function(t,s,a){"use strict";a.r(s);var n=a(103),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"文件上传漏洞"}},[t._v("文件上传漏洞 "),a("a",{staticClass:"header-anchor",attrs:{href:"#文件上传漏洞"}},[t._v("#")])]),t._v(" "),a("h1",{attrs:{id:"常见检测和绕过方式"}},[t._v("常见检测和绕过方式 "),a("a",{staticClass:"header-anchor",attrs:{href:"#常见检测和绕过方式"}},[t._v("#")])]),t._v(" "),a("h2",{attrs:{id:"客户端校验"}},[t._v("客户端校验 "),a("a",{staticClass:"header-anchor",attrs:{href:"#客户端校验"}},[t._v("#")])]),t._v(" "),a("h3",{attrs:{id:"检测"}},[a("strong",[t._v("检测")]),t._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#检测"}},[t._v("#")])]),t._v(" "),a("p",[t._v("javascript校验（一般只校验后缀名）")]),t._v(" "),a("h3",{attrs:{id:"绕过"}},[a("strong",[t._v("绕过")]),t._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#绕过"}},[t._v("#")])]),t._v(" "),a("p",[t._v("开Burp代理，随便点击浏览“”选择文件，但是还没点击“上传”，就弹出警告框，说明流量没经过burp代理；")]),t._v(" "),a("p",[t._v("所以非常可能是客户端JavaScript检测。")]),t._v(" "),a("p",[t._v("burp拦截修改后缀名(Content-Length要看情况修改）")]),t._v(" "),a("h2",{attrs:{id:"服务端校验"}},[t._v("服务端校验 "),a("a",{staticClass:"header-anchor",attrs:{href:"#服务端校验"}},[t._v("#")])]),t._v(" "),a("h3",{attrs:{id:"校验"}},[a("strong",[t._v("校验")]),t._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#校验"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("1.MIME检测 文件头content-type字段校验（image/gif）\t；burp拦截修改Content-Type，或者上传gif改后缀名")]),t._v(" "),a("p",[t._v("2.文件内容头校验（GIF89a）\t\t\t\t\t\t\t\t\t\t\t\t  ；在恶意脚本前添加GIF89a标识；一句话前后加图片数据混淆")]),t._v(" "),a("p",[t._v("3.文件扩展名校验  (白名单、黑名单)")]),t._v(" "),a("p",[t._v("4.文件内容检测 (检测内容是否合法或含有恶意代码)")])]),t._v(" "),a("h3",{attrs:{id:"绕过-2"}},[a("strong",[t._v("绕过")]),t._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#绕过-2"}},[t._v("#")])]),t._v(" "),a("p",[a("strong",[t._v("黑名单绕过：")])]),t._v(" "),a("blockquote",[a("p",[t._v("找漏网之鱼：cer、php3、php4等 (PHP版本<5.3可使用%00截断)\n大小写绕过：AsP、pHP")]),t._v(" "),a("p",[t._v("文件后缀复写绕过")]),t._v(" "),a("p",[t._v("上传不符合windows文件命名规则的文件名\ntest.php:1.jpg\ntest.php::$DATA\n会被windows系统自动去掉不符合规则符号后面的内容")]),t._v(" "),a("p",[t._v("配合解析漏洞绕过")])]),t._v(" "),a("p",[a("strong",[t._v("白名单绕过：")])]),t._v(" "),a("blockquote",[a("p",[t._v("%00截断 (PHP<5.3.4时 shell.php%00.jpg 可截断%00后的内容)\n配合解析漏洞绕过")])]),t._v(" "),a("p",[t._v("黑白名单通用，如果可上传修改 "),a("code",[t._v(".htaccess")]),t._v(" 文件 (还能用于隐藏后门) -> 内容检测不行")]),t._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("FilesMatch "),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[t._v('"shell.jpg"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n SetHandler application"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("httpd"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("php\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("FilesMatch"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//上传shell.jpg文件，将解析为php运行")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[a("strong",[t._v("文件加载检测(文件内容检测)")])]),t._v(" "),a("p",[t._v("常见的是对图像进行二次渲染，一般是调用PHP 的GD库")]),t._v(" "),a("p",[t._v("一个绕过GD库的Webshell生成器：http://wiki.ioin.in/soft/detail/1q")]),t._v(" "),a("p",[t._v("上边那个不行的话，试试"),a("a",{attrs:{href:"https://github.com/RickGray/Bypass-PHP-GD-Process-To-RCE",target:"_blank",rel:"noopener noreferrer"}},[t._v("这个"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"竞争条件攻击"}},[t._v("竞争条件攻击 "),a("a",{staticClass:"header-anchor",attrs:{href:"#竞争条件攻击"}},[t._v("#")])]),t._v(" "),a("p",[t._v("一些网站允许上传任意文件，然后检测文件是否包含Webshell，如果有则删除该文件。")]),t._v(" "),a("blockquote",[a("p",[t._v("服务器端在处理不同用户的请求时是并发进行的")]),t._v(" "),a("p",[t._v("如果并发处理不当或相关操作逻辑顺序设计的不合理时，将导致条件竞争漏洞")])]),t._v(" "),a("p",[t._v("如这样一段代码")]),t._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token php language-php"}},[a("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("isset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'src'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("copy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'src'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'dst'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unlink")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'dst'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("?>")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("它先把文件保存在本地，再检查，然后删除")]),t._v(" "),a("p",[t._v("在上传完成和安全检查删除它的间隙，攻击者用多线程不断的发起访问请求该文件")]),t._v(" "),a("p",[t._v("该文件就会被执行从而生成一个恶意shell")]),t._v(" "),a("p",[a("strong",[t._v("竞争删除前生成shell流程：")])]),t._v(" "),a("blockquote",[a("p",[t._v("上传文件→访问执行文件，生成shell文件→删除不安全文件 \t(多线程访问)")])]),t._v(" "),a("p",[a("strong",[t._v("Create_shell.php")])]),t._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token php language-php"}},[a("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fputs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fopen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'../shell.php'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'w'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[t._v("'<?php @eval($_POST[123]) ?>'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token delimiter important"}},[t._v("?>")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[a("strong",[t._v("防御方案：")])]),t._v(" "),a("p",[t._v("对于文件上传，在将文件保存在本地前就进行相应的安全检查")]),t._v(" "),a("h2",{attrs:{id:"针对各种-cms-和-编辑器"}},[t._v("针对各种 CMS 和 编辑器 "),a("a",{staticClass:"header-anchor",attrs:{href:"#针对各种-cms-和-编辑器"}},[t._v("#")])]),t._v(" "),a("p",[t._v("可以针对不同CMS存在的上传漏洞进行绕过。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://article.itxueyuan.com/kyWmXr",target:"_blank",rel:"noopener noreferrer"}},[t._v("PHPCMSv9.6.0 任意文件上传"),a("OutboundLink")],1),t._v("( CVE-2018-14399 )")]),t._v(" "),a("p",[t._v("FCKeditor，ewebeditor 等，可以针对编辑器的漏洞进行绕过。")]),t._v(" "),a("h1",{attrs:{id:"修复建议"}},[t._v("修复建议 "),a("a",{staticClass:"header-anchor",attrs:{href:"#修复建议"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("1、使用白名单限制可以上传的文件扩展名")]),t._v(" "),a("p",[t._v("2、注意0x00截断攻击（PHP更新到最新版本）")]),t._v(" "),a("p",[t._v("3、对上传后的文件统一随机命名，不允许用户控制扩展名")]),t._v(" "),a("p",[t._v("4、上传文件的存储目录禁用执行权限")])]),t._v(" "),a("h2",{attrs:{id:"代码审计方法"}},[t._v("代码审计方法 "),a("a",{staticClass:"header-anchor",attrs:{href:"#代码审计方法"}},[t._v("#")])]),t._v(" "),a("p",[t._v("代码审计中关注以下函数")]),t._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("move_uploaded_file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//将上传的文件移动到新位置")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("全局搜索"),a("code",[t._v("$_FILES")]),t._v("变量，定位到相关的上传过程查看过滤是否严格。")])])}),[],!1,null,null,null);s.default=e.exports}}]);